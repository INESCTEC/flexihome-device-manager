version: "3.9"

services:

  # ------------------- THESE CONTAINERS ARE USED FOR TESTING PURPOSES ------------------- #

  # MULTIPLE DB INSTANCES IN ONE IMAGE
  # https://github.com/mrts/docker-postgresql-multiple-databases
  postgresql:
    image: postgres:latest
    container_name: postgresql
    restart: unless-stopped
    ports:
      - "5432:5432"
    command: [ "postgres", "-c", "wal_level=logical" ]
    environment:
      - POSTGRES_MULTIPLE_DATABASES="devicemanager","account_manager","jwt_token_management"
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=mysecretpassword
    volumes:
      - ./docker-postgresql-multiple-databases:/docker-entrypoint-initdb.d
  
  zookeeper:
    image: debezium/zookeeper:1.6
    container_name: zookeeper
    ports:
      - "2888:2888"
      - "2181:2181"
      - "3888:3888"
    restart: unless-stopped

  kafka:
    image: debezium/kafka:1.6
    container_name: kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    restart: unless-stopped
    environment:
      - ZOOKEEPER_CONNECT=zookeeper:2181
  
  connect:
    image: debezium/connect:1.6
    container_name: connect
    depends_on:
      - kafka
    ports:
      - "8083:8083"
    restart: unless-stopped
    environment:
      - GROUP_ID=1
      - CONFIG_STORAGE_TOPIC=my_connect_configs
      - OFFSET_STORAGE_TOPIC=my_connect_offsets
      - STATUS_STORAGE_TOPIC=my_connect_statuses
      - BOOTSTRAP_SERVERS=kafka:9092

  account-manager:
    # uses the latest production image
    image: docker-registry.inesctec.pt/cpes/european-projects/interconnect/hems/hems-services/account-manager-service:latest
    container_name: account-manager-test
    restart: unless-stopped
    depends_on:
      - postgresql
      - connect
    ports:
      - "8081:8080"
    environment:
      - DATABASE_IP=postgresql
      - DATABASE_PORT=5432
      - DATABASE_USER=postgres
      - DATABASE_PASSWORD=mysecretpassword
      - KAFKA_BROKER_ENDPOINT=kafka:9092
      - GITLAB_CI_TEST=True
      - JWT_SIGN_KEY=f797b720a53f8e9c71d33700f2a703acea28985dd427369a3f55f48ba171998e408b44c072c1d9dfb06192aa6808c8a9e28b68dbe842d0c1473405fc298f31708ad12168bcdeb642ba619866ae1c0a49fa4fa248818535105ec7931901589de6b4f316273994003db830f23331b12c9da51415d479ead7729bb30c7df54aaf78

  # device-manager-service:
  #   image: device-manager-service:latest
  #   build:
  #     context: ../
  #   container_name: device-manager-service
  #   restart: unless-stopped
  #   depends_on:
  #     - postgresql
  #     - connect
  #   ports:
  #    - "8080:8080"
  #   environment:
  #     - DATABASE_IP=postgresql
  #     - DATABASE_PORT=5432
  #     - DATABASE_USER=postgres
  #     - DATABASE_PASSWORD=mysecretpassword
  #     - KAFKA_BROKER_ENDPOINT=kafka:9092

  #     - AUTH_DATABASE_USER=postgres
  #     - AUTH_DATABASE_PASSWORD=mysecretpassword

  #     - DATABASE_IP_ACCOUNT=postgresql
  #     - DATABASE_PORT_ACCOUNT=5432
  #     - DATABASE_USER_ACCOUNT=postgres
  #     - DATABASE_PASSWORD_ACCOUNT=mysecretpassword

  #     - WHIRLPOOL_GA_URL=http://ga-wp:9090
  #     - BSH_GA_URL=http://ga:9090

  #     - TESTING=True
  #     - HANDLE_DEBUG_FLAG=True

  #     - GITLAB_DEPLOY_TOKEN=$GITLAB_DEPLOY_TOKEN
  #     - GITLAB_DEPLOY_USERNAME=$GITLAB_DEPLOY_USERNAME
  #     - GITLAB_SSA_MANAGER_DEPLOY_TOKEN=$GITLAB_SSA_MANAGER_DEPLOY_TOKEN
  

  ga:
    image: docker-registry.inesctec.pt/interconnect/generic-adapter:2.2.4
    container_name: ga
    restart: unless-stopped
    ports:
      - "9090:9090"
      - "9001:9001"
    environment:
      - KE_HOST=https://ke-pt.interconnectproject.eu/rest/
      - service-store.check-recipientSelector=false  # Needed for spine adapter with recipient selector active
  
  ga-global:
    image: docker-registry.inesctec.pt/interconnect/generic-adapter:2.2.4
    container_name: ga-global
    restart: unless-stopped
    ports:
      - "9091:9090"
    environment:
      - KE_HOST=https://ke.interconnectproject.eu/rest/

# Create a network with custom options
# networks:                                
#   default:                               
#     driver: bridge                       
#     driver_opts:                         
#       com.docker.network.driver.mtu: 1200
  
  # elasticsearch:
  #   container_name: temporal-elasticsearch
  #   environment:
  #     - cluster.routing.allocation.disk.threshold_enabled=true
  #     - cluster.routing.allocation.disk.watermark.low=512mb
  #     - cluster.routing.allocation.disk.watermark.high=256mb
  #     - cluster.routing.allocation.disk.watermark.flood_stage=128mb
  #     - discovery.type=single-node
  #     - ES_JAVA_OPTS=-Xms100m -Xmx100m
  #   image: elasticsearch:7.10.1
  #   # networks:
  #   #   - temporal-network
  #   # network_mode: veth-hems
  #   ports:
  #     - 9200:9200
  
  # temporal:
  #   container_name: temporal
  #   depends_on:
  #     - postgresql
  #     - elasticsearch
  #   environment:
  #     - DB=postgresql
  #     - DB_PORT=5432
  #     - POSTGRES_USER=postgres
  #     - POSTGRES_PWD=mysecretpassword
  #     - POSTGRES_SEEDS=postgresql
  #     - DYNAMIC_CONFIG_FILE_PATH=config/dynamicconfig/development_es.yaml
  #     - ENABLE_ES=true
  #     - ES_SEEDS=elasticsearch
  #     - ES_VERSION=v7
  #   image: temporalio/auto-setup:1.13.1
  #   # networks:
  #   #   - temporal-network
  #   # network_mode: veth-hems
  #   ports:
  #     - 7233:7233
  #   volumes:
  #     - ./dynamicconfig:/etc/temporal/config/dynamicconfig
  
  # temporal-admin-tools:
  #   container_name: temporal-admin-tools
  #   depends_on:
  #     - temporal
  #   environment:
  #     - TEMPORAL_CLI_ADDRESS=temporal:7233
  #   image: temporalio/admin-tools:1.13.1
  #   # networks:
  #   #   - temporal-network
  #   # network_mode: veth-hems
  #   stdin_open: true
  #   tty: true
  
  # temporal-web:
  #   container_name: temporal-web
  #   depends_on:
  #     - temporal
  #   environment:
  #     - TEMPORAL_GRPC_ENDPOINT=temporal:7233
  #     - TEMPORAL_PERMIT_WRITE_API=true
  #   image: temporalio/web:1.13.0
  #   # networks:
  #   #   - temporal-network
  #   # network_mode: veth-hems
  #   ports:
  #     - 8088:8088

  # influx-db-service:
  #   image: influxdb:2.1
  #   container_name: influxdb
  #   volumes:
  #    - influxdb:/var/lib/influxdb2
  #   environment:
  #    - DOCKER_INFLUXDB_INIT_MODE=setup
  #    - DOCKER_INFLUXDB_INIT_USERNAME=cpes
  #    - DOCKER_INFLUXDB_INIT_PASSWORD=mysecretpassword
  #    - DOCKER_INFLUXDB_INIT_ORG=inesctec
  #    - DOCKER_INFLUXDB_INIT_BUCKET=interconnect-eot-meters
  #   #  - DOCKER_INFLUXDB_INIT_RETENTION=1w
  #    - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=KnbXcUIzAE0-2cNfC-w1yz8MbsPZGpV6XTZbXdcJtIVHZEkFgiYoEgKv0NtMZbnl-DRbEaPX0bk5Fy-5UbBnOg==
  #   # network_mode: veth-hems
  #   ports:
  #    - 8086:8086

# networks:
#   device-manager:

volumes:
  influxdb:

