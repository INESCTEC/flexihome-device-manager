openapi: 3.0.0

info:
  description: "Device Manager Service OpenAPI definition.


    This service has the following functions: scan, add, delete, send commands, view measurements and state of the devices.


    Find out more: [Device Manager Service documentation](https://gitlab.inesctec.pt/cpes/european-projects/interconnect/hems/hems-documentation/-/blob/master/Microservices/Device-Manager-Service.adoc)"

  version: 1.0.0
  title: Device Manager Service
  contact:
    name: Vasco Campos
    email: vasco.m.campos@inesctec.pt

servers:
  - url: https://interconnect-dev.inesctec.pt/api/device

tags:
  - name: Mock endpoints
    description: For testing purposes only
  - name: Device management
    description: For managing appliances
  - name: Pool requests
    description: For managing pools
  - name: Device schedules
    description: For managing device operation cycles
  - name: SSA endpoints
    description: For interoperability management


############################################################################
################################# REQUESTS #################################
############################################################################

paths:
  /ssa/device/allow-hems:
    description: Allow HEMS to manage the device.
    post:
      summary: Allow HEMS to manage the device.
      tags:
        - SSA endpoints
      parameters:
        - $ref: "#/components/parameters/CorrelationId"
        - $ref: "#/components/parameters/Authorization"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AllowHemsRequestBody"
      responses:
        200:
          description: Device is now managed by the HEMS.
          headers:
            X-Correlation-ID:
              $ref: "#/components/headers/CorrelationId"
        400:
          $ref: "#/components/responses/BadRequest"
        401:
          $ref: "#/components/responses/InvalidCredentials"
        403:
          $ref: "#/components/responses/Forbidden"
        404:
          $ref: "#/components/responses/SerialNumberNotFound"

  /get-user-wp-appliances:
    description: Get appliances associated with the user's HotPoint Home Net account.
    get:
      summary: Get appliances associated with the user's HotPoint Home Net account.
      tags:
        - SSA endpoints
      parameters:
        - $ref: "#/components/parameters/CorrelationId"
        - $ref: "#/components/parameters/RequiredAuthorization"
      responses:
        200:
          description: List of devices of user accounts.
          headers:
            X-Correlation-ID:
              $ref: "#/components/headers/CorrelationId"
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Device"
        400:
          $ref: "#/components/responses/BadRequest"
        401:
          $ref: "#/components/responses/InvalidCredentials"
        403:
          $ref: "#/components/responses/Forbidden"
        404:
          $ref: "#/components/responses/UserIdNotFound"

  /bsh-devices:
    description: Fetch user's devices from its HomeConnect account after the user completed any BSH OAuth flow.
    get:
      summary: BSH "follow" request for any BSH device
      tags:
        - SSA endpoints
      parameters:
        - $ref: "#/components/parameters/BshBrand"
        - $ref: "#/components/parameters/Token"
        - $ref: "#/components/parameters/DeviceIds"
        - $ref: "#/components/parameters/SSA"
      responses:
        201:
          description: Bosch devices received and saved to DB
          headers:
            X-Correlation-ID:
              $ref: "#/components/headers/CorrelationId"
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Device"
        204:
          description: Bosch devices already associated to user account
          headers:
            X-Correlation-ID:
              $ref: "#/components/headers/CorrelationId"
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Device"
                example: []
        400:
          $ref: "#/components/responses/BadRequest"
        401:
          $ref: "#/components/responses/InvalidCredentials"
        403:
          $ref: "#/components/responses/Forbidden"
        404:
          $ref: "#/components/responses/UserIdNotFound"
        500:
          $ref: "#/components/responses/DatabaseError"
  
  /device:
    description: Endpoints to manage devices.

    get:
      summary: List all devices per user account.
      tags:
        - Device management
      parameters:
        - $ref: "#/components/parameters/CorrelationId"
        - $ref: "#/components/parameters/Authorization"
        - $ref: "#/components/parameters/NonRequiredUserIds"
      responses:
        200:
          description: List of devices of user accounts.
          headers:
            X-Correlation-ID:
              $ref: "#/components/headers/CorrelationId"
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/UserDeviceList"
        400:
          $ref: "#/components/responses/BadRequest"
        401:
          $ref: "#/components/responses/InvalidCredentials"
        403:
          $ref: "#/components/responses/Forbidden"
        404:
          $ref: "#/components/responses/UserIdNotFound"

    post:
      summary: Add device to user account.
      tags:
        - Mock endpoints
      deprecated: true
      parameters:
        - $ref: "#/components/parameters/CorrelationId"
        - $ref: "#/components/parameters/RequiredAuthorization"
        - $ref: "#/components/parameters/Brand"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AddDeviceRequestBody"
      responses:
        200:
          description: Added device to user account.
          headers:
            X-Correlation-ID:
              $ref: "#/components/headers/CorrelationId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Device"
        400:
          $ref: "#/components/responses/BadRequest"
        401:
          $ref: "#/components/responses/InvalidCredentials"
        403:
          $ref: "#/components/responses/Forbidden"
        404:
          $ref: "#/components/responses/UserIdNotFound"
        409:
          description: Device already exists in users account (409 Conflict)
          headers:
            X-Correlation-ID:
              $ref: "#/components/headers/CorrelationId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

    delete:
      summary: Remove device from user account.
      tags:
        - Device management
      parameters:
        - $ref: "#/components/parameters/CorrelationId"
        - $ref: "#/components/parameters/RequiredAuthorization"
        - $ref: "#/components/parameters/SerialNumber"
        - $ref: "#/components/parameters/DeleteType"
      responses:
        200:
          description: Removed device from user account.
          headers:
            X-Correlation-ID:
              $ref: "#/components/headers/CorrelationId"
        400:
          $ref: "#/components/responses/BadRequest"
        401:
          $ref: "#/components/responses/InvalidCredentials"
        403:
          $ref: "#/components/responses/Forbidden"
        404:
          $ref: "#/components/responses/SerialNumberNotFound"

  /schedule-cycle-by-device:
    description: Mock manufacturer method to schedule a cycle to a machine.
    post:
      summary: Schedule new cycle for appliance (MOCK manufacturer SSA endpoint).
      tags:
        - Mock endpoints
      deprecated: true
      parameters:
        - $ref: "#/components/parameters/CorrelationId"
        - $ref: "#/components/parameters/Authorization"
        - $ref: "#/components/parameters/SerialNumber"

      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ScheduleCycleRequestBody"

      responses:
        200:
          description: Cycle created successfully
          headers:
            X-Correlation-ID:
              $ref: "#/components/headers/CorrelationId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MachineCycle"

        400:
          $ref: "#/components/responses/BadRequest"
        401:
          $ref: "#/components/responses/InvalidCredentials"
        403:
          $ref: "#/components/responses/Forbidden"
        404:
          $ref: "#/components/responses/UserIdNotFound"

    get:
      summary: Get scheduled cycles per device.
      tags:
        - Device schedules
      parameters:
        - $ref: "#/components/parameters/CorrelationId"
        - $ref: "#/components/parameters/Authorization"
        - $ref: "#/components/parameters/SerialNumbers"
        - $ref: "#/components/parameters/StartTimestamp"
        - $ref: "#/components/parameters/EndTimestamp"

      responses:
        200:
          description: List of machine scheduled cycles per device
          headers:
              X-Correlation-ID:
                $ref: "#/components/headers/CorrelationId"
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/MachineCycleByDevice"

  /schedule-cycle-by-user:
    description: Scheduled cycles per user.
    get:
      summary: Get scheduled cycles per user.
      tags:
        - Device schedules
      parameters:
        - $ref: "#/components/parameters/CorrelationId"
        - $ref: "#/components/parameters/Authorization"
        - $ref: "#/components/parameters/UserIds"
        - $ref: "#/components/parameters/StartTimestamp"
        - $ref: "#/components/parameters/EndTimestamp"
        - $ref: "#/components/parameters/IsOptimized"

      responses:
        200:
          description: List of machine scheduled cycles by user
          headers:
            X-Correlation-ID:
              $ref: "#/components/headers/CorrelationId"
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/MachineCycleByUser"

  /request-delay-by-cycle:
    description: Request the delay of a machine cycle to the manufacturer SSA
    post:
      summary: Request the delay of a machine cycle to the manufacturer SSA
      tags:
        - SSA endpoints
      parameters:
        - $ref: "#/components/parameters/CorrelationId"
        - $ref: "#/components/parameters/Authorization"
        - $ref: "#/components/parameters/UserIdQuery"
        - $ref: "#/components/parameters/RecommendationId"

      requestBody:
        required: true
        description:
          Send delay requests to each 'sequence_id',
          as long as it belons to the user 'user_id'.
          The 'new_start_time' MUST be in UTC.
        content:
          application/json:
            schema:
              type: array
              items:
                $ref: "#/components/schemas/DelaysByCycleRequestBody"

      responses:
        207:
          description: |
            Delay requests sent to and returned from the manufacturer successfully.
            Each delay has its own chance of failing, making this a multi-status request (207).
          headers:
            X-Correlation-ID:
              $ref: "#/components/headers/CorrelationId"
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/DelaysStatus"  # Add a message for when delay fails on SSA

        400:
          $ref: "#/components/responses/BadRequest"
        401:
          $ref: "#/components/responses/InvalidCredentials"
        403:
          $ref: "#/components/responses/Forbidden"
        404:
          $ref: "#/components/responses/UserIdNotFound"

  /pool-by-user:
    description: Endpoint to get the day ahead pool of schedules per user.
    get:
      summary: Get scheduled pools per user.
      tags:
        - Pool requests
      deprecated: true
      parameters:
        - $ref: "#/components/parameters/CorrelationId"
        - $ref: "#/components/parameters/Authorization"
        - $ref: "#/components/parameters/UserIds"

      responses:
        200:
          description: List of all devices per user and their schedules in the pool (day ahead)
          headers:
              X-Correlation-ID:
                $ref: "#/components/headers/CorrelationId"
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/PoolByUser"

              examples:
                pool with multiple devices:
                  $ref: "#/components/examples/pool_example"

  /pool-by-device:
    description: Endpoint to manage the day ahead pool of schedules per device.
    get:
      summary: Get scheduled pool per device.
      tags:
        - Pool requests
      deprecated: true
      parameters:
        - $ref: "#/components/parameters/CorrelationId"
        - $ref: "#/components/parameters/Authorization"
        - $ref: "#/components/parameters/SerialNumbers"

      responses:
        200:
          description: List of devices and their schedules in the pool (day ahead)
          headers:
              X-Correlation-ID:
                $ref: "#/components/headers/CorrelationId"
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/PoolByDevice"

  /perfect-pool-by-user:
    description: Perfect pools per user.
    get:
      summary: Get perfect pools per user.
      tags:
        - Pool requests
      parameters:
        - $ref: "#/components/parameters/CorrelationId"
        - $ref: "#/components/parameters/Authorization"
        - $ref: "#/components/parameters/UserIds"
        - $ref: "#/components/parameters/StartDate"
        - $ref: "#/components/parameters/EndDate"

      responses:
        200:
          description: List of perfect pools by user
          headers:
              X-Correlation-ID:
                $ref: "#/components/headers/CorrelationId"
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/PoolByUser"

  /settings-by-device:
    description: Endpoint to manage settings per device.

    get:
      summary: Get settings per device.
      tags:
        - Device management
      parameters:
        - $ref: "#/components/parameters/CorrelationId"
        - $ref: "#/components/parameters/Authorization"
        - $ref: "#/components/parameters/SerialNumbers"
      responses:
        200:
          description: Device settings
          headers:
            X-Correlation-ID:
              $ref: "#/components/headers/CorrelationId"
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/SettingsByDevice"

        400:
          $ref: "#/components/responses/BadRequest"
        401:
          $ref: "#/components/responses/InvalidCredentials"
        403:
          $ref: "#/components/responses/Forbidden"
        404:
          $ref: "#/components/responses/UserIdNotFound"
    post:
      summary: Update not disturb settings per device.
      tags:
        - Device management
      parameters:
        - $ref: "#/components/parameters/CorrelationId"
        - $ref: "#/components/parameters/Authorization"
        - $ref: "#/components/parameters/SerialNumber"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/NotDisturb"
      responses:
        200:
          description: Device settings
          headers:
            X-Correlation-ID:
              $ref: "#/components/headers/CorrelationId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Settings"
        400:
          $ref: "#/components/responses/BadRequest"
        401:
          $ref: "#/components/responses/InvalidCredentials"
        403:
          $ref: "#/components/responses/Forbidden"
        404:
          $ref: "#/components/responses/UserIdNotFound"
  
  /device/settings/set-automatic-management:
    description: Endpoint to set automatic management of settings per device.
    post:
      summary: Set automatic management of settings per device.
      tags:
        - Device management
      parameters:
        - $ref: "#/components/parameters/CorrelationId"
        - $ref: "#/components/parameters/Authorization"
        - $ref: "#/components/parameters/SerialNumber"
      responses:
        200:
          description: Device's automatic management settings changed.
          headers:
            X-Correlation-ID:
              $ref: "#/components/headers/CorrelationId"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AutomaticManagementResponseBody"
        400:
          $ref: "#/components/responses/BadRequest"
        401:
          $ref: "#/components/responses/InvalidCredentials"
        403:
          $ref: "#/components/responses/Forbidden"
        404:
          $ref: "#/components/responses/UserIdNotFound"
          

  /settings-by-user:
    description: Endpoint to get settings of all devices of user.
    get:
      summary: Get settings of all devices of user.
      tags:
        - Device management
      parameters:
        - $ref: "#/components/parameters/CorrelationId"
        - $ref: "#/components/parameters/Authorization"
        - $ref: "#/components/parameters/UserIds"
      responses:
        200:
          description: List of all devices of user and their settings
          headers:
            X-Correlation-ID:
              $ref: "#/components/headers/CorrelationId"
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/SettingsByUser"

        400:
          $ref: "#/components/responses/BadRequest"
        401:
          $ref: "#/components/responses/InvalidCredentials"
        403:
          $ref: "#/components/responses/Forbidden"
        404:
          $ref: "#/components/responses/UserIdNotFound"



############################################################################
############################## AUTHORIZATION ###############################
############################################################################

security:
  - {}
  - Bearer: []

components:
  securitySchemes:
    Bearer: # arbitrary name for the security scheme
      type: http
      scheme: bearer
      bearerFormat: JWT


############################################################################
################################# HEADERS ##################################
############################################################################

  headers:
    CorrelationId:
      required: true
      schema:
        $ref: "#/components/schemas/CorrelationId"

    Authorization:
      required: true
      schema:
        $ref: "#/components/schemas/Authorization"

  parameters:
    CorrelationId:
      in: header
      name: X-Correlation-ID
      required: true
      schema:
        $ref: "#/components/schemas/CorrelationId"

    RequiredAuthorization:
      in: header
      name: Authorization
      required: true
      schema:
        $ref: "#/components/schemas/Authorization"

    Authorization:
      in: header
      name: Authorization
      schema:
        $ref: "#/components/schemas/Authorization"



############################################################################
############################## PATH PARAMETERS #############################
############################################################################

    UserId:
      in: path
      name: user-id
      required: true
      schema:
        $ref: "#/components/schemas/UserId"



############################################################################
############################# QUERY PARAMETERS #############################
############################################################################

    UserIdQuery:
      in: query
      name: user-id
      required: true
      schema:
        $ref: "#/components/schemas/UserId"

    UserIds:
      in: query
      name: user_ids
      required: true
      schema:
        type: array
        items:
          $ref: "#/components/schemas/UserId"
        example: [userId1, userId2]
        minItems: 1

    NonRequiredUserIds:
      in: query
      name: user_ids
      required: false
      schema:
        type: array
        items:
          $ref: "#/components/schemas/UserId"
        example: [userId1, userId2]
        minItems: 1

    DeviceIds: # For SpineAdapter follow url
      in: query
      name: device_ids
      required: true
      schema:
        type: array
        items:
          $ref: "#/components/schemas/SerialNumber"
        example: [000185888214, BOSCH-WAX28EH0ES-68A40E946F87]
    
    SerialNumbers:
      in: query
      name: serial_numbers
      required: true
      schema:
        type: array
        items:
          $ref: "#/components/schemas/SerialNumber"
        example: [000185888214, BOSCH-WAX28EH0ES-68A40E946F87]
        minItems: 1

    SerialNumber:
      in: query
      name: serial_number
      required: true
      schema:
        $ref: "#/components/schemas/SerialNumber"

    Delays:
      in: query
      name: delays
      required: true
      schema:
        type: array
        items:
          $ref: "#/components/schemas/Timestamp"
        example: [2022-06-30T23:59:59Z, 2022-06-30T23:59:59Z]
        minItems: 1

    Brand:
      in: query
      name: brand
      required: true
      schema:
        $ref: "#/components/schemas/Brand"
    
    BshBrand:
      in: query
      name: device_brand
      required: true
      schema:
        $ref: "#/components/schemas/BshBrand"

    StartDate:
      in: query
      name: start_date
      required: true
      schema:
        $ref: "#/components/schemas/Date"

    EndDate:
      in: query
      name: end_date
      required: true
      schema:
        $ref: "#/components/schemas/Date"

    StartTimestamp:
      in: query
      name: start_timestamp
      required: false
      schema:
        $ref: "#/components/schemas/Timestamp"

    EndTimestamp:
      in: query
      name: end_timestamp
      required: false
      schema:
        $ref: "#/components/schemas/Timestamp"

    IsOptimized:
      in: query
      name: is_cycle_optimized
      required: false
      schema:
        $ref: "#/components/schemas/Optimized"

    DeleteType:
      in: query
      name: delete_type
      required: true
      schema:
        $ref: "#/components/schemas/DeleteType"

    # BOSCH SPECIFIC PARAMETERS
    Token:
      in: query
      name: token
      required: true
      schema:
        $ref: "#/components/schemas/UserId"

    SSA:
      in: query
      name: ssa
      required: true
      schema:
        type: string
        example: XXX

    RecommendationId:
      description: Link to a recommendation on the energy manager service
      in: query
      name: recommendation_id
      required: false
      schema:
        type: integer
        example: 1




############################################################################
############################# GENERAL SCHEMAS ##############################
############################################################################

  schemas:
    CorrelationId:
      type: string
      format: uuid

    UserId:
      type: string
      example: 4c5e80dfjc
      minLength: 10
      maxLength: 10

    Authorization:
      type: string
      format: byte # base64

    Timestamp:
      type: string
      format: date-time
      example: "2022-06-30T23:59:59Z"

    Date:
      type: string
      format: date
      pattern: (((19|20)([2468][048]|[13579][26]|0[48])|2000)[/-]02[/-]29|((19|20)[0-9]{2}[/-](0[4678]|1[02])[/-](0[1-9]|[12][0-9]|30)|(19|20)[0-9]{2}[/-](0[1359]|11)[/-](0[1-9]|[12][0-9]|3[01])|(19|20)[0-9]{2}[/-]02[/-](0[1-9]|1[0-9]|2[0-8])))
      example: "2022-05-17"

    Delayed:
      type: boolean
      example: true

    Optimized:
      type: string
      enum: ["true", "false"]
      example: "false"

    DeleteType:
      type: string
      enum:
        - soft
        - hard
      example: "soft"


# ------------------------------------------------------------------------- #

    # Deprecated
    AddDeviceRequestBody:
      type: object
      properties:
        serial_number:
          $ref: "#/components/schemas/SerialNumber"

    # Deprecated
    RemoveDeviceRequestBody:
      type: object
      properties:
        serial_number:
          $ref: "#/components/schemas/SerialNumber"
      required:
        - serial_number


    # Mock endpoint
    ScheduleCycleRequestBody:
      example:
        program: cotton
        scheduled_start_time: 2022-06-30T23:59:59Z
      properties:
        scheduled_start_time:
          example: 2022-06-30T23:59:59Z
          format: date-time
          title: earliest_start_time
          type: string
        program:
          $ref: '#/components/schemas/WashingProgram'
      required:
      - program
      - scheduled_start_time
      type: object

# ------------------------------------------------------------------------- #



############################################################################
############################## GENERAL DEVICE ##############################
############################################################################

    # Useful if we have another type of device (thermal p.e.)
    Device:
      oneOf:
        - $ref: '#/components/schemas/ShiftableMachine'

    UserDeviceList:
      type: object
      properties:
        user_id:
          $ref: "#/components/schemas/UserId"
        devices:
          type: array
          items:
            $ref: "#/components/schemas/Device"
      required:
        - user_id
        - devices


############################################################################
############################# SHIFTABLE MACHINE ############################
############################################################################

    ShiftableMachine:
      type: object
      properties:
        serial_number:
          $ref: "#/components/schemas/SerialNumber"
        name:
          $ref: "#/components/schemas/DeviceName"
        device_type:
          $ref: "#/components/schemas/ApplianceType"
        brand:
          $ref: "#/components/schemas/Brand"
        allow_hems:
          type: boolean
          example: true
        automatic_management:
          type: boolean
          example: true
        device_ssa:
          type: string
          example: https://ke-pt.interconnectproject.eu/rest/adapter/hems-spine-adapter
        not_disturb:
          $ref: "#/components/schemas/NotDisturb"
      required:
        - device_type
        - brand
        - serial_number
        - not_disturb
        - allow_hems
        - automatic_management

    DeviceName:
      type: string
      example: "my home washer"

    Brand:
      type: string
      example: "Hotpoint"
    
    BshBrand:
      type: string
      enum: ["bosch", "miele", "bsh"]
      example: bosch

    SerialNumber:
      type: string
      example: "WPR4LLLG8NWD4" # DeviceAddress

    ApplianceType:
      type: string
      example: "FabricCare"

    PowerUnits:
      type: string
      enum: ["W", "kW"]


    NotDisturb:
      type: object
      properties:
        sunday:
          type: array
          items:
            $ref: "#/components/schemas/PeriodOfDay"
        monday:
          type: array
          items:
            $ref: "#/components/schemas/PeriodOfDay"
        tuesday:
          type: array
          items:
            $ref: "#/components/schemas/PeriodOfDay"
        wednesday:
          type: array
          items:
            $ref: "#/components/schemas/PeriodOfDay"
        thursday:
          type: array
          items:
            $ref: "#/components/schemas/PeriodOfDay"
        friday:
          type: array
          items:
            $ref: "#/components/schemas/PeriodOfDay"
        saturday:
          type: array
          items:
            $ref: "#/components/schemas/PeriodOfDay"

    PeriodOfDay:
      type: object
      properties:
        start_timestamp:
          $ref: "#/components/schemas/Timestamp"
        end_timestamp:
          $ref: "#/components/schemas/Timestamp"
      required:
        - start_timestamp
        - end_timestamp


############################################################################
########################## SHIFTABLE MACHINE CYCLE #########################
############################################################################

    ShiftableMachineCycle:
      type: object
      properties:
        sequence_id: # Later can be used to delay this sequence
          $ref: "#/components/schemas/SequenceId"
        earliest_start_time:
          $ref: "#/components/schemas/Timestamp"
        latest_end_time:
          $ref: "#/components/schemas/Timestamp"
        scheduled_start_time:
          $ref: "#/components/schemas/Timestamp"
        expected_end_time:
          $ref: "#/components/schemas/Timestamp"
        program:
          $ref: "#/components/schemas/WashingProgram"
        is_optimized: # True se resultar da decis√£o do HEMS
          type: boolean
          example: true
        power_profile:
          type: array
          items:
            $ref: "#/components/schemas/PowerProfile"
      required:
        - sequence_id
        - scheduled_start_time
        - expected_end_time
        - program
        - is_optimized
        - power_profile

    SequenceId:
      type: string
      example: "40A45E3C-AEDF-456A-A7F8-5A9FF3F8CD97"

    WashingProgram:
      type: string
      example: "cotton"


    PowerProfile:
      type: object
      properties:
        slot:
          type: integer
          example: 1
        max_power:
          type: number
          example: 300
          minimum: 0
        min_power:
          type: number
          example: 100
          minimum: 0
        expected_power:
          type: number
          example: 200
          minimum: 0
        power_units:
          $ref: "#/components/schemas/PowerUnits"
        duration:
          type: number
          example: 4.0
          minimum: 0
        duration_units:
          type: string
          example: minutes
          enum: [minutes]
      required:
        - slot
        - max_power
        - power_units
        - duration
        - duration_units

    MachineCycleByDevice:
      type: object
      properties:
        serial_number:
          $ref: "#/components/schemas/SerialNumber"
        cycles:
          type: array
          items:
            $ref: "#/components/schemas/MachineCycle"
      required:
        - serial_number
        - cycles

    MachineCycleByUser:
      type: object
      properties:
        user_id:
          $ref: "#/components/schemas/UserId"
        cycles:
          type: array
          items:
            $ref: "#/components/schemas/MachineCycleByDevice"
      required:
        - user_id
        - cycles



############################################################################
############################# MACHINE SETTINGS #############################
############################################################################

    Settings:
      oneOf:
        - $ref: '#/components/schemas/ShiftableMachineSettings'

    ShiftableMachineSettings:
      type: object
      properties:
        serial_number:
          $ref: "#/components/schemas/SerialNumber"
        # device_type:
        #   $ref: "#/components/schemas/ApplianceType"
        # brand:
        #   $ref: "#/components/schemas/Brand"
        not_disturb:
          $ref: "#/components/schemas/NotDisturb"
        allow_hems:
          type: boolean
          example: true
        automatic_management:
          type: boolean
          example: true
      required:
        - serial_number
        - not_disturb
        - allow_hems
        - automatic_management


    SettingsByDevice:
      type: object
      properties:
        settings:
          type: array
          items:
            $ref: "#/components/schemas/Settings"
      required:
        - settings

    SettingsByUser:
      type: object
      properties:
        user_id:
          $ref: "#/components/schemas/UserId"
        settings:
          type: array
          items:
            $ref: "#/components/schemas/Settings"
      required:
        - user_id
        - settings



############################################################################
#################################### POOL ##################################
############################################################################

    Pool:
      type: object
      properties:
        serial_number:
          $ref: "#/components/schemas/SerialNumber"
        device_type:
          $ref: "#/components/schemas/ApplianceType"
        cycles_in_pool:
          type: array
          items:
            $ref: "#/components/schemas/MachineCycle"
      required:
        - serial_number
        - cycles_in_pool

    # Useful if we have more types of appliances other than shiftable
    MachineCycle:
      oneOf:
        - $ref: "#/components/schemas/ShiftableMachineCycle"


    PoolByDevice:
      type: object
      properties:
        pool:
          type: array
          items:
            $ref: "#/components/schemas/Pool"
      required:
        - pool

    PoolByUser:
      type: object
      properties:
        user_id:
          $ref: "#/components/schemas/UserId"
        pool:
          type: array
          items:
            $ref: "#/components/schemas/Pool"
      required:
        - user_id
        - pool



############################################################################
################################## DELAY ###################################
############################################################################

    DelaysByCycleRequestBody:
      type: object
      properties:
        sequence_id:
          $ref: "#/components/schemas/SequenceId"
        serial_number:
          $ref: "#/components/schemas/SerialNumber"
        new_start_time:
          $ref: "#/components/schemas/Timestamp"
      required:
        - sequence_id
        - serial_number
        - new_start_time

    DelaysStatus:
      type: object
      properties:
        sequence_id:
          $ref: "#/components/schemas/SequenceId"
        serial_number:
          $ref: "#/components/schemas/SerialNumber"
        delayed:
          $ref: "#/components/schemas/Delayed"
        message:
          type: string
          example: "Delayed successfully"
      required:
        - sequence_id
        - serial_number
        - delayed
        - message



############################################################################
################################ ALLOW EMS #################################
############################################################################

    AllowHemsRequestBody:
      type: object
      properties:
        device_ssa:
          type: string
          example: https://ke-pt.interconnectproject.eu/rest/adapter/hems-spine-adapter
        serial_number:
          $ref: "#/components/schemas/SerialNumber"
        allow_hems:
          type: boolean
          example: true
      required:
        - device_ssa
        - serial_number
        - allow_hems
    

    AutomaticManagementResponseBody:
      type: object
      properties:
        automatic_management:
          type: boolean
          example: true
      required:
        - automatic_management




############################################################################
################################## ERRORS ##################################
############################################################################

    Error:
      description: Error model
      type: object
      properties:
        error:
          type: string
      required:
        - error


############################################################################
################################# RESPONSES ################################
############################################################################

  responses:
    BadRequest:
      description: Bad Request
      headers:
        X-Correlation-ID:
          $ref: "#/components/headers/CorrelationId"
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          examples:
            Timestamp error:
              value:
                error: "one or more timestamps in the request are invalid"
            Missing X-Correlation-ID header:
              value:
                error: "missing X-Correlation-ID header"

    InvalidCredentials:
      description: Unauthenticated or invalid credentials
      headers:
        X-Correlation-ID:
          $ref: "#/components/headers/CorrelationId"
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          examples:
            Unauthenticated:
              value:
                error: "error in authorization token"

    Forbidden:
      description: Forbidden to access the information requested
      headers:
        X-Correlation-ID:
          $ref: "#/components/headers/CorrelationId"
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          examples:
            Forbidden:
              value:
                error: "you are not authorized to access this information"

    UserIdNotFound:
      description: User id not found
      headers:
        X-Correlation-ID:
          $ref: "#/components/headers/CorrelationId"
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          examples:
            User Id not found:
              value:
                error: 'user with id "userId" not found'

    SerialNumberNotFound:
      description: Device id not found
      headers:
        X-Correlation-ID:
          $ref: "#/components/headers/CorrelationId"
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          examples:
            Device Id not found:
              value:
                error: 'device with id "serial_number" not found'
    
    DatabaseError:
      description: Error in database session. Try again.
      headers:
        X-Correlation-ID:
          $ref: "#/components/headers/CorrelationId"
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Error"
          examples:
            Database Error:
              value:
                error: 'Unable to complete database process'


############################################################################
################################# EXAMPLES #################################
############################################################################

  examples:
    wm_wp_no_cycles:
      value:
        attributes:
          name: "my washer"
          device_type: "FabricCare"
          brand: "Hotpoint"
          serial_number: "WPR4LLLG8NWD4"
        washing_cycles: []
        not_disturb: []

    pool_example:
      value:
        - user_id: "4c5e80dfjc"
          pool:
            - serial_number: "Miele-Dishwasher-1029999753"
              device_type: Dishwasher
              brand: Miele
              name: "my Miele dishwasher"
              cycles_in_pool:
                - sequence_id: 40A45E3C-AEDF-456A-A7F8-5A9FF3F8CD97
                  earliest_start_time: 01-04-2022T06:00:00Z
                  latest_end_time: 01-04-2022T23:00:00Z
                  scheduled_start_time: 01-04-2022T10:00:00Z
                  expected_end_time: 01-04-2022T11:30:00Z
                  program: cotton
                  is_optimized: true
                  power_profile:
                    - slot: 1
                      max_power: 300
                      power_units: W
                      duration: 4.0
                      duration_units: minutes
                    - slot: 2
                      max_power: 2600
                      power_units: W
                      duration: 76.0
                      duration_units: minutes
                    - slot: 3
                      max_power: 100
                      power_units: W
                      duration: 2.0
                      duration_units: minutes
                    - slot: 4
                      max_power: 1100
                      power_units: W
                      duration: 15.0
                      duration_units: minutes

            - serial_number: "Bosch-Dryer-1290999325"
              device_type: Dryer
              cycles_in_pool:
                - sequence_id: 40A45E3C-AEDF-456A-A7F8-92D0221S
                  earliest_start_time: 01-04-2022T06:00:00Z
                  latest_end_time: 01-04-2022T23:00:00Z
                  scheduled_start_time: 01-04-2022T16:00:00Z
                  expected_end_time: 01-04-2022T17:30:00Z
                  program: cotton
                  is_optimized: true
                  power_profile:
                    - slot: 1
                      max_power: 200
                      min_power: 100
                      expected_power: 120
                      power_units: W
                      duration: 4.0
                      duration_units: minutes
                    - slot: 2
                      max_power: 1900
                      min_power: 1000
                      expected_power: 1300
                      power_units: W
                      duration: 65.0
                      duration_units: minutes
                    - slot: 3
                      max_power: 230
                      min_power: 80
                      expected_power: 200
                      power_units: W
                      duration: 5.0
                      duration_units: minutes
                    - slot: 4
                      max_power: 890
                      min_power: 340
                      expected_power: 510
                      power_units: W
                      duration: 20.0
                      duration_units: minutes

        - user_id: "58ol2se2lb"
          pool:
            - serial_number: "WPR4LLLG8NWD4"
              name: "my home washer"
              device_type: FabricCare
              cycles_in_pool:
                - sequence_id: 02LL221-AE2F-412A-A7ST-028KKL22HF
                  earliest_start_time: 01-04-2022T06:00:00Z
                  latest_end_time: 01-04-2022T23:00:00Z
                  scheduled_start_time: 01-04-2022T08:00:00Z
                  expected_end_time: 01-04-2022T09:30:00Z
                  program: easy_care
                  is_optimized: true
                  power_profile:
                    - slot: 1
                      max_power: 200
                      power_units: W
                      duration: 13.0
                      duration_units: minutes
                    - slot: 2
                      max_power: 1000
                      power_units: W
                      duration: 47.0
                      duration_units: minutes
                    - slot: 3
                      max_power: 100
                      power_units: W
                      duration: 5.0
                      duration_units: minutes
